<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dontpad | Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #0b0e14; color: white; min-height: 100vh; overflow-x: hidden; }
        #particles-js { position: fixed; width: 100%; height: 100%; z-index: 1; }
        .container { position: relative; z-index: 2; padding: 40px; max-width: 1000px; margin: auto; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .info-data { font-size: 0.8rem; color: #3b82f6; font-weight: 600; margin-top: 5px; }
        
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; text-decoration: none; display: inline-block; text-transform: uppercase; font-size: 0.75rem; }
        .btn-edit-mode { background: #f59e0b; color: #000; } /* Cor Laranja para Modo Edi√ß√£o */
        .btn-save { background: #238636; color: white; display: none; } /* Escondido por padr√£o */
        .btn-copy { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-delete { background: #da3633; color: white; }
        .btn-back { background: transparent; border: 1px solid #30363d; color: white; margin-bottom: 10px; }

        .file-section { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid #30363d; border-radius: 15px; padding: 25px; margin-bottom: 30px; transition: 0.3s; }
        .editing .file-section { border-color: #f59e0b; background: rgba(245, 158, 11, 0.02); }
        
        .file-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        input.filename-edit { background: transparent; border: none; color: #3b82f6; font-weight: 600; font-size: 1.1rem; outline: none; width: 70%; }
        
        textarea.code-editor { width: 100%; background: #0d1117; color: #e6edf3; border: 1px solid #30363d; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.9rem; resize: vertical; min-height: 250px; outline: none; transition: 0.3s; }
        textarea:read-only { opacity: 0.6; cursor: not-allowed; }
        .editing textarea { border-color: #f59e0b; background: #111; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal-content { background: #161b22; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #30363d; }
    </style>
</head>
<body id="bodyTag">

    <div id="particles-js"></div>

    <div class="container">
        <header>
            <div>
                <a href="inicio.html" class="btn btn-back">‚Üê Voltar</a>
                <h1 id="projTitle">Carregando...</h1>
                <p id="lastUpdate" class="info-data"></p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btnEdit" class="btn btn-edit-mode" onclick="enableEditing()">‚úé Editar C√≥digo</button>
                <button id="btnSave" class="btn btn-save" onclick="updateProject()">üíæ Salvar Altera√ß√µes</button>
                <button class="btn btn-delete" onclick="openModal('deleteModal')">Excluir</button>
            </div>
        </header>

        <div id="editorArea"></div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #238636;">Atualizado!</h2>
            <p id="successMsg" style="margin-top:15px; color: #ccc;"></p>
            <button class="btn btn-back" style="margin-top:20px; width:100%; background: #238636; border: none;" onclick="closeModal('successModal')">Entendido</button>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #da3633;">Apagar Projeto?</h2>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-delete" style="flex:1" onclick="confirmDelete()">Apagar</button>
                <button class="btn btn-back" style="flex:1" onclick="closeModal('deleteModal')">Manter</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnYLjBFGwMq4oZcfcdNcuijmLYKykQEuA",
            authDomain: "dondpad-b8d61.firebaseapp.com",
            projectId: "dondpad-b8d61",
            storageBucket: "dondpad-b8d61.firebasestorage.app",
            messagingSenderId: "239814047608",
            appId: "1:239814047608:web:dc7ec62b28587e0109ba8d",
            measurementId: "G-XNXSSBN0H8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const projectId = new URLSearchParams(window.location.search).get('id');

        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // ATIVA MODO EDI√á√ÉO
        window.enableEditing = () => {
            document.getElementById('bodyTag').classList.add('editing');
            document.querySelectorAll('.code-editor, .filename-edit').forEach(el => el.readOnly = false);
            document.getElementById('btnEdit').style.display = 'none';
            document.getElementById('btnSave').style.display = 'inline-block';
        };

        async function loadProject() {
            if(!projectId) return window.location.href = 'inicio.html';
            const docSnap = await getDoc(doc(db, "projetos", projectId));

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('projTitle').innerText = data.nome;
                if(data.lastEdit) document.getElementById('lastUpdate').innerText = `Editado em: ${data.lastEdit} ‚úÖ`;

                const area = document.getElementById('editorArea');
                area.innerHTML = data.files.map((file, i) => `
                    <div class="file-section">
                        <div class="file-header">
                            <input type="text" class="filename-edit" value="${file.n}" id="name-${i}" readonly>
                            <button class="btn btn-copy" onclick="copyCode(${i})">Copiar</button>
                        </div>
                        <textarea class="code-editor" id="code-${i}" readonly>${file.c}</textarea>
                    </div>
                `).join('');
            }
        }

        window.updateProject = async () => {
            const names = document.querySelectorAll('.filename-edit');
            const codes = document.querySelectorAll('.code-editor');
            const now = new Date().toLocaleString('pt-BR');
            
            let files = [];
            names.forEach((n, i) => files.push({ n: n.value, c: codes[i].value }));

            try {
                await updateDoc(doc(db, "projetos", projectId), { files, lastEdit: now });
                
                // Feedback visual de sucesso
                document.getElementById('successMsg').innerText = `As altera√ß√µes foram salvas com sucesso √†s ${now.split(',')[1]}.`;
                openModal('successModal');
                
                // Reseta interface
                document.getElementById('bodyTag').classList.remove('editing');
                document.querySelectorAll('.code-editor, .filename-edit').forEach(el => el.readOnly = true);
                document.getElementById('btnEdit').style.display = 'inline-block';
                document.getElementById('btnSave').style.display = 'none';
                document.getElementById('lastUpdate').innerText = `Editado em: ${now} ‚úÖ`;
            } catch (e) { alert("Erro ao salvar."); }
        };

        window.copyCode = (i) => {
            navigator.clipboard.writeText(document.getElementById(`code-${i}`).value);
            alert("C√≥digo Copiado!");
        };

        window.confirmDelete = async () => {
            await deleteDoc(doc(db, "projetos", projectId));
            window.location.href = 'inicio.html';
        };

        loadProject();
    </script>

    <script>
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 80 },
                "color": { "value": "#3b82f6" },
                "opacity": { "value": 0.2 },
                "line_linked": { "enable": true, "distance": 150, "color": "#3b82f6", "opacity": 0.1 },
                "move": { "enable": true, "speed": 1 }
            },
            "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" } } }
        });
    </script>
</body>
</html>